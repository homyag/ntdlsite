# Документация проекта "ТД Ленинградский" (Django)

## Обзор проекта

"ТД Ленинградский" — это веб-сайт для бетонного завода, разработанный на Django. Сайт предоставляет информацию о продукции компании (бетон, нерудные материалы, асфальт), позволяет клиентам рассчитывать стоимость доставки, объем бетона для различных конструкций, а также оставлять заявки на обратный звонок и получение консультации.

## Структура проекта

Проект разделен на несколько Django-приложений, каждое из которых отвечает за определенную функциональность:

### 1. `new_tdl_site` (основной проект)
- Основные настройки проекта
- URL-маршрутизация
- Настройки Celery для фоновых задач
- Конфигурация sitemap

### 2. `commonpages` (общие страницы)
- Главная страница
- Страница "О компании"
- Контакты
- Услуги
- Калькуляторы (доставки и бетона)
- Обработка форм обратной связи

### 3. `good` (продукция)
- Модели товаров, категорий и городов
- Каталог продукции
- Страницы товаров
- Фильтрация товаров по категориям и городам

### 4. `blog` (блог)
- Заготовка для раздела блога (минимальная реализация)

### 5. `leads` (лиды/заявки)
- Управление заявками клиентов
- API для бота Telegram
- Система уведомлений для менеджеров
- Задачи для Celery (напоминания о заявках)

## Модели данных

### `good` (продукция)

#### `Product`
- `name`: Название товара
- `slug`: URL-идентификатор
- `description`: Полное описание
- `product_card_description`: Краткое описание для карточки товара
- `product_card_property`: Свойства товара
- `price`: Цена
- `on_stock`: Наличие на складе
- `img`: Изображение товара
- `category`: Связь с моделью Category
- `city`: Связь с моделью City
- SEO-поля (meta_title, meta_description, meta_keywords)

#### `Category`
- `name`: Название категории
- `slug`: URL-идентификатор
- `parent`: Родительская категория (для иерархии категорий)
- `description`: Описание категории
- `small_text_for_catalog`: Краткий текст для страницы каталога
- SEO-поля

#### `City`
- `name`: Название города
- `slug`: URL-идентификатор
- `region`: Регион города

### `commonpages` (общие страницы)

#### `CallbackRequest`
- `name`: Имя клиента
- `phone`: Телефон клиента
- `created_at`: Время создания заявки

#### `FeedbackRequest`
- `name`: Имя клиента
- `email`: Email клиента
- `phone`: Телефон клиента
- `product`: Связь с моделью Product
- `message`: Сообщение клиента
- `created_at`: Время создания заявки

### `leads` (лиды/заявки)

#### `Result`
- `name`: Название результата (статус заявки)

#### `Manager`
- `name`: Имя менеджера
- `mail`: Email менеджера
- `tg_id`: ID менеджера в Telegram

#### `Call`
- `created`: Дата звонка
- `resource`: Источник заявки
- `phone`: Телефон клиента
- `mail`: Email клиента
- `name`: Имя клиента/организации
- `result`: Связь с моделью Result
- `comment`: Комментарий к заявке
- `manager`: Связь с моделью Manager
- `date_of_notification`: Дата уведомления

#### `Good`
- `category`: Категория товара
- `name`: Название товара
- `article`: Артикул
- `price`: Цена

#### `CallItem`
- `call`: Связь с моделью Call
- `good`: Связь с моделью Good
- `price`: Цена
- `quantity`: Количество

## URLs и маршрутизация

### Основные маршруты
- `/` - Главная страница
- `/about/` - О компании
- `/contacts/` - Контакты
- `/services/` - Услуги
- `/services/delivery/` - Калькулятор доставки
- `/service/calc/` - Калькулятор бетона
- `/blog/` - Блог
- `/privacy/` - Политика конфиденциальности

### Каталог товаров
- `/<city_slug>/` - Каталог по городу
- `/<city_slug>/<category_slug>/` - Товары по категории
- `/<city_slug>/<category_slug>/<product_slug>/` - Страница товара

### API для Telegram-бота
- `/api/v1/callslist/` - Список заявок (GET) и создание заявки (POST)
- `/api/v1/managers/` - Список менеджеров (GET) и создание менеджера (POST)
- `/api/v1/results/` - Список возможных результатов заявок
- `/api/v1/callslist/<int:pk>/` - Обновление заявки
- `/api/v1/callslist/call/<int:pk>/` - Получение данных о заявке
- `/api/v1/callslist/manager-tg/<int:tg_id>/` - Список заявок по ID менеджера в Telegram
- `/api/v1/callslist/filter/` - Фильтрация заявок

## Фронтенд

Проект использует стандартный шаблонизатор Django с кастомными JavaScript-скриптами:

### JavaScript-скрипты
- `cityModal.js` - Выбор города
- `concreteCalculator.js` - Калькулятор бетона
- `deliveryCalculator.js` - Калькулятор доставки
- `feedbackForm.js` - Обработка формы обратной связи
- `headerCallbackPopup.js` - Обработка формы заказа звонка
- `headerNavDisplay.js` - Мобильное меню
- `contactsMapChanger.js` - Изменение карт на странице контактов
- `telegram-popup.js` - Всплывающее окно с приглашением в Telegram-канал

### CSS-стили
- `styles.css` - Основные стили сайта
- `modal.css` - Стили для модальных окон
- `telegram-popup.css` - Стили для Telegram-попапа

## Интеграции

1. **Telegram-бот**
   - Уведомления о новых заявках
   - Управление заявками через бота
   - Напоминания о дедлайнах

2. **Яндекс.Карты**
   - Калькулятор доставки
   - Карты на странице контактов

3. **reCAPTCHA**
   - Защита форм от спама

4. **Аналитика**
   - Google Tag Manager
   - Яндекс.Метрика

## Асинхронные задачи (Celery)

Проект использует Celery и Redis для выполнения фоновых задач:

- `check_notifications` - Ежедневная проверка заявок и отправка уведомлений менеджерам о приближающихся дедлайнах

## Middleware

1. `ApiTokenMiddleware`
   - Проверка API-токена для доступа к API

2. `CityMiddleware`
   - Обработка выбранного города пользователя

## Context Processors

1. `default_context`
   - Добавляет в контекст основное меню сайта

2. `city_context`
   - Добавляет в контекст информацию о текущем городе и список всех городов

## Signals (Django signals)

1. Уведомления о новых заявках
   ```python
   @receiver(post_save, sender=CallbackRequest)
   def notify_operator_on_callback_request(sender, instance, created, **kwargs):
       # Отправка уведомления в Telegram
   ```

2. Уведомления о изменении статуса заявки
   ```python
   @receiver(post_save, sender=Call)
   def notify_users_on_call_change(sender, instance, created, **kwargs):
       # Отправка уведомления менеджеру
   ```

## Настройки проекта

### Основные настройки
- Django 4.2.20
- База данных: PostgreSQL
- Статические файлы: локальный сервер (в продакшне можно изменить)
- Медиа-файлы: локальный сервер
- Timezone: Europe/Moscow
- Language: ru-ru

### Внешние зависимости
Основные зависимости проекта (из requirements.txt):
- Django 4.2.20
- Celery 5.4.0
- Redis (для Celery)
- django-filter 24.3
- djangorestframework 3.15.2
- Pillow 10.4.0 (для работы с изображениями)
- psycopg (драйвер PostgreSQL)
- python-dotenv (для работы с переменными окружения)

## Запуск проекта

### Переменные окружения
Проект использует `.env` файл для хранения секретных настроек:
```
DJANGO_SECRET=django-insecure-;ldlamaf34f49_asm+912m.,mczxc.a,sdn_
BOT_TOKEN=TG_BOT_TOKEN
API_TOKEN=DRF_API_TOKEN
RECAPTCHA_SECRET_KEY=YOUR_RECAPTCHA_API_KEY
DB_ENGINE=django.db.backends.postgresql
DB_NAME=dbname
DB_USER=user
DB_PASS=12345
DB_HOST=localhost
DB_PORT=5432
OPERATOR_TG_ID=YOUR_OPERATOR_TG_ID
ADMIN_TG_ID=YOUR_ADMIN_TG_ID
```

### Запуск сервера Django
```bash
python manage.py runserver
```

### Запуск Celery
```bash
# Запуск Redis
redis-server

# Запуск Celery Worker
celery -A new_tdl_site worker --loglevel=info

# Запуск Celery Beat
celery -A new_tdl_site worker --beat
```

## API-интерфейсы

### Методы API для Telegram-бота
- **GET `/api/v1/callslist/`**: Получение списка всех заявок
- **POST `/api/v1/callslist/`**: Создание новой заявки
- **PUT/PATCH `/api/v1/callslist/<id>/`**: Обновление заявки
- **GET `/api/v1/callslist/call/<id>/`**: Получение информации о заявке
- **GET `/api/v1/callslist/manager-tg/<tg_id>/`**: Получение списка заявок по ID менеджера в Telegram
- **PUT/PATCH `/api/v1/callslist/comment_update/<id>/`**: Обновление комментария к заявке
- **PUT/PATCH `/api/v1/callslist/result_update/<id>/`**: Обновление статуса заявки
- **PUT/PATCH `/api/v1/callslist/manager_update/<id>/`**: Изменение ответственного менеджера

## Безопасность

1. **reCAPTCHA**
   - Защита форм от спама и ботов

2. **Защита API**
   - Middleware для проверки токена при обращении к API

3. **CSRF-защита**
   - Использование CSRF-токенов в формах

## SEO-оптимизация

1. **Sitemap**
   - Генерация XML-карты сайта с изображениями
   - Включение в карту сайта всех продуктов, категорий и статических страниц

2. **Метатеги**
   - Поддержка SEO-оптимизированных заголовков, описаний и ключевых слов для каждой страницы

3. **robots.txt**
   - Настроенный файл robots.txt для поисковых роботов

## Примеры использования

### Калькулятор бетона
Калькулятор позволяет рассчитать необходимый объем бетона для:
- Фундаментных плит
- Колонн
- Ленточных фундаментов

После расчета система показывает подходящие товары из каталога с учетом требований к марке бетона для выбранного типа конструкции.

### Калькулятор доставки
Использует Яндекс.Карты для расчета расстояния от завода до точки доставки и вычисляет стоимость доставки с учетом объема заказа.

### Управление заявками через Telegram
Менеджеры получают уведомления о новых заявках и могут управлять ими через Telegram-бота:
- Добавлять комментарии
- Менять статус заявки
- Передавать заявку другому менеджеру

## Расширение проекта

### Возможные улучшения
1. Добавление личного кабинета для клиентов
2. Интеграция с CRM-системой
3. Онлайн-оплата заказов
4. Расширение блога с функционалом комментариев
5. Интеграция с системами аналитики данных

## Примечания по развертыванию

### Рекомендации для продакшена
1. Изменить `DEBUG = False` в settings.py
2. Настроить NGINX/Apache для обслуживания статических и медиа-файлов
3. Настроить HTTPS с помощью Let's Encrypt
4. Настроить Supervisor для управления процессами Django и Celery
5. Настроить регулярное резервное копирование базы данных
6. Включить настройки безопасности в settings.py:
   ```python
   SECURE_BROWSER_XSS_FILTER = True
   SECURE_CONTENT_TYPE_NOSNIFF = True
   X_FRAME_OPTIONS = 'DENY'
   SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
   ```

## Архитектура проекта

Проект следует типичной MVT-архитектуре Django с некоторыми расширениями:
- **Models**: Модели данных в каждом приложении
- **Views**: Представления для обработки запросов
- **Templates**: HTML-шаблоны
- **Middleware**: Обработка запросов до и после прохождения через представление
- **Signals**: Обработка событий жизненного цикла моделей
- **Tasks**: Асинхронные задачи для фоновой обработки
- **API**: REST API для интеграции с внешними системами

Такая архитектура обеспечивает хорошую модульность и возможность расширения проекта в будущем.